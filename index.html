Formato del record:
Operazione (FE = Fatture Emesse; FR = Fatture Ricevute); numero operazioni; partita_iva o codice_fiscale; imponibile; iva
<hr>

<input type="file" id="files" name="files[]"/>
<output id="res"></output>

<script>
	var soggetti = [];
	
	function handleFileSelect(evt) {
		var reader = new FileReader();
		reader.onload = function(e) {
			function isNumeric(num) { return (num >= 0 || num < 0); }
			
			function add_record(f) {
				var piva = String(f[2]);
				if (soggetti[piva] === undefined) {
					soggetti[piva] = [];
					soggetti[piva][0] = {n: 0, imp: 0, iva: 0}; //fatture emesse
					soggetti[piva][1] = {n: 0, imp: 0, iva: 0}; //note credito emesse
					soggetti[piva][2] = {n: 0, imp: 0, iva: 0}; //fatture ricevute
					soggetti[piva][3] = {n: 0, imp: 0, iva: 0}; //note credito ricevute
				}
				var idx	= (f[0][1] == "E") ? 0 : 2;
				if (f[3] < 0) idx++;
				soggetti[piva][idx].n += parseInt(f[1]);
				soggetti[piva][idx].imp += parseFloat(f[3]);
				soggetti[piva][idx].iva += parseFloat(f[4]);
			}
		
			var v = e.target.result.split("\n");
			for (var i=0; i < v.length; i++) {
				v[i].trim();
				if (v[i].substr(0, 2) == "//") continue;
				var f = v[i].split("\t");
				var valid_line = true;
				if (f.length != 5) valid_line = false;
				else {
					f[3] = f[3].replace(".","").replace(",",".");
					f[4] = f[4].replace(".","").replace(",",".");
					if (f[0] != "FE" && f[0] != "FR") valid_line = false;
					else if (! isNumeric(f[1])) valid_line = false;
					else if (f[2].length < 11 || f[2].length > 16) valid_line = false;
					else if (! isNumeric(f[3])) valid_line = false;
					else if (! isNumeric(f[4])) valid_line = false;
				}
				
				if (valid_line) add_record(f);
				else document.getElementById('res').innerHTML += "<br>Errore nella linea: " + (i+1);
			}
			
			
			
			function download(filename, text) {
				var pom = document.createElement('a');
				pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
				pom.setAttribute('download', filename);
				pom.click();
			}
			download('test.txt', creaComunicazione("CF SOGGETTO"));
		};
	
		reader.readAsText(evt.target.files[0]);
	}

	function creaComunicazione(CF_soggetto) {
		var n_sog = 0;
		var n_recC_ = 1;
	
		function fillerAN(len) {
			return new Array( len +1 ).join( ' ' );
		}		
		function formattaCF(str) {
			return str + (new Array( 17 - str.length ).join( ' ' ));
		}
		function formattaNP(str) {
			var res = Math.floor(str);
			if (res == 0) res = 1;
			res = res.toFixed(0);
			return (new Array( 17 - res.length ).join( ' ' )) + res;
		}
		function formattaNU(str, len) {
			var res = Math.floor(str).toFixed(0);
			return (new Array( len + 1 - res.length ).join( '0' )) + res;
		}

		function creaRecordA(CF_soggetto) {		
			var res = "A";
			res += fillerAN(14);
			res += "NSP00";
			res += "01";
			res += formattaCF(CF_soggetto);
			res += fillerAN(483);
			res += formattaNU(1, 4);
			res += formattaNU(1, 4);
			res += fillerAN(1368);
			res += "A\r\n"
			return res;
		}

		function creaRecordC(CF_soggetto) {
			function intestazione(progressivo_modulo) {
				var res = "C";
				res += formattaCF(CF_soggetto);
				res += ("       " + progressivo_modulo.toString()).slice(-8);
				res += new Array( 49 ).join( ' ' );
				res += formattaCF("ID SOFT");
				return res;
			}

			var tmp = [];
			n_sog = 0;
			for (sog in soggetti) {		
				n_sog++;
				var prefisso = "000" + n_sog.toString();
				prefisso  = "FA" + prefisso.slice(-3);

				if (sog.length > 11) tmp.push(prefisso + "002");
				else tmp.push(prefisso + "001");
				tmp.push(formattaCF(sog));
				var op_attive = soggetti[sog][0].n + soggetti[sog][3].n;
				var op_passive = soggetti[sog][1].n + soggetti[sog][2].n;
				if (op_attive > 0) {
					tmp.push(prefisso + "004");
					tmp.push(formattaNP(op_attive.toString()));
				}
				if (op_passive > 0) {
					tmp.push(prefisso + "005");
					tmp.push(formattaNP(op_passive.toString()));
				}
				if (soggetti[sog][0].n > 0) {
					tmp.push(prefisso + "007");
					tmp.push(formattaNP(soggetti[sog][0].imp));
					tmp.push(prefisso + "008");
					tmp.push(formattaNP(soggetti[sog][0].iva));
				}
				if (soggetti[sog][3].n > 0) {
					tmp.push(prefisso + "010");
					tmp.push(formattaNP(soggetti[sog][3].imp));
					tmp.push(prefisso + "011");
					tmp.push(formattaNP(soggetti[sog][3].iva));
				}
				if (soggetti[sog][2].n > 0) {
					tmp.push(prefisso + "012");
					tmp.push(formattaNP(soggetti[sog][2].imp));
					tmp.push(prefisso + "013");
					tmp.push(formattaNP(soggetti[sog][2].iva));
				}
				if (soggetti[sog][1].n > 0) {
					tmp.push(prefisso + "015");
					tmp.push(formattaNP(soggetti[sog][1].imp));
					tmp.push(prefisso + "016");
					tmp.push(formattaNP(soggetti[sog][1].iva));
				}
			}
		
			var res = ""
			n_recC_ = 1;
			res += intestazione(n_recC_);
			var n_record = 0;
			for (var i=0; i < tmp.length; i++) {
				if (n_record++ == 150) {
					n_record = 1;				
					res += "        A\r\n"; //Chiusura del record
					res += intestazione(++n_recC_);
				}
				res += tmp[i];
			}
			var spazi_filler = (150 - n_record) * 12;
			res += new Array( spazi_filler +1 ).join( ' ' );
			res += "        A\r\n"; //Chiusura del record
			return res;
		}
	
		function creaRecordE(CF_soggetto) {
			var res = "E";
			res += formattaCF(CF_soggetto);
			res += "       1";
			res += fillerAN(48);
			res += formattaCF("ID SOFT");
			res += "TA001001";
			res += formattaNP(n_sog);
			res += fillerAN(1776);
			res += "        A\r\n"; //Chiusura del record
			return res;
		}
		
		function creaRecordZ() {		
			var res = "Z";
			res += fillerAN(14);			
			res += formattaNU(1, 9);
			res += formattaNU(n_recC_, 9);
			res += formattaNU(0, 9);
			res += formattaNU(1, 9);
			res += fillerAN(1846);
			res += "A\r\n"
			return res;
		}

		var res = creaRecordA(CF_soggetto);
		res += creaRecordC(CF_soggetto);
		res += creaRecordE(CF_soggetto);
		res += creaRecordZ();
		return res;	
	}

	document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>
